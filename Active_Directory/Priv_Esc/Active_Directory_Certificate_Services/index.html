<!doctype html><html lang=en class=color-toggle-hidden code-theme=dark><head><meta charset=utf-8><meta name=referrer content="no-referrer"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=generator content="Hugo 0.103.0"><meta name=description content="ADCS Information These notes are mainly summarized from the Specterops paper linked below. https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
https://tryhackme.com/room/adcertificatetemplates
ADCS is Microsoft&rsquo;s PKI implementation. ADCS is used for several things such as encrypting file systems, creating and verifying digital signatures, and even user authentication. What makes ADCS a good attack vector is that these certificates survive credential rotation. If a compromised account&rsquo;s password is reset or the system reimaged, the attacker created certificate would still be valid providing persistence."><title>Active Directory Certificate Services | Offensive Playbook</title><link rel=icon type=image/svg+xml href=/favicon/favicon.svg><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta property="og:title" content="Active Directory Certificate Services"><meta property="og:site_name" content="Offensive Playbook"><meta property="og:description" content="ADCS Information These notes are mainly summarized from the Specterops paper linked below. https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
https://tryhackme.com/room/adcertificatetemplates
ADCS is Microsoft’s PKI implementation. ADCS is used for several things such as encrypting file systems, creating and verifying digital signatures, and even user authentication. What makes ADCS a good attack vector is that these certificates survive credential rotation. If a compromised account’s password is reset or the system reimaged, the attacker created certificate would still be valid providing persistence."><meta property="og:type" content="article"><meta property="og:url" content="https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/"><meta property="article:section" content="Active Directory"><meta name=twitter:card content="summary"><meta name=twitter:title content="Active Directory Certificate Services"><meta name=twitter:description content="ADCS Information These notes are mainly summarized from the Specterops paper linked below. https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
https://tryhackme.com/room/adcertificatetemplates
ADCS is Microsoft’s PKI implementation. ADCS is used for several things such as encrypting file systems, creating and verifying digital signatures, and even user authentication. What makes ADCS a good attack vector is that these certificates survive credential rotation. If a compromised account’s password is reset or the system reimaged, the attacker created certificate would still be valid providing persistence."><script type=application/ld+json>{"@context":"http://schema.org","@type":"TechArticle","articleSection":"Active Directory","name":"Active Directory Certificate Services","url":"https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/","headline":"Active Directory Certificate Services","description":"ADCS Information These notes are mainly summarized from the Specterops paper linked below. https:\/\/www.specterops.io\/assets\/resources\/Certified_Pre-Owned.pdf\nhttps:\/\/tryhackme.com\/room\/adcertificatetemplates\nADCS is Microsoft’s PKI implementation. ADCS is used for several things such as encrypting file systems, creating and verifying digital signatures, and even user authentication. What makes ADCS a good attack vector is that these certificates survive credential rotation. If a compromised account’s password is reset or the system reimaged, the attacker created certificate would still be valid providing persistence.","wordCount":"1716","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/"},"copyrightHolder":"Offensive Playbook","copyrightYear":"0001","dateCreated":"0001-01-01T00:00:00.00Z","datePublished":"0001-01-01T00:00:00.00Z","dateModified":"0001-01-01T00:00:00.00Z","publisher":{"@type":"Organization","name":"Offensive Playbook","url":"https://ab0x90.github.io","logo":{"@type":"ImageObject","url":"https://ab0x90.github.io/brand.svg","width":"32","height":"32"}}}</script><script src=/js/main-51ef884d.bundle.min.js></script>
<link rel=preload as=font href=/fonts/Metropolis.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload href=/main-2437a034.min.css as=style><link rel=stylesheet href=/main-2437a034.min.css media=all><link rel=preload href=/mobile-467819cb.min.css as=style><link rel=stylesheet href=/mobile-467819cb.min.css media="screen and (max-width: 45rem)"><link rel=preload href=/print-19966b38.min.css as=style><link rel=stylesheet href=/print-19966b38.min.css media=print><link rel=preload href=/custom.css as=style><link rel=stylesheet href=/custom.css media=all><link href=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/ rel=canonical type=text/html></head><body itemscope itemtype=https://schema.org/WebPage><svg class="svg-sprite" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><svg viewBox="-7.27 -7.27 38.55 38.55" id="gdoc_arrow_back" xmlns="http://www.w3.org/2000/svg"><path d="M24 10.526v2.947H5.755l8.351 8.421-2.105 2.105-12-12 12-12 2.105 2.105-8.351 8.421H24z"/></svg><svg viewBox="-7.27 -7.27 38.55 38.55" id="gdoc_arrow_left_alt" xmlns="http://www.w3.org/2000/svg"><path d="M5.965 10.526V6.035L0 12l5.965 5.965v-4.491H24v-2.947H5.965z"/></svg><svg viewBox="-7.27 -7.27 38.55 38.55" id="gdoc_arrow_right_alt" xmlns="http://www.w3.org/2000/svg"><path d="M18.035 10.526V6.035L24 12l-5.965 5.965v-4.491H0v-2.947h18.035z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_bitbucket" xmlns="http://www.w3.org/2000/svg"><path d="M15.905 13.355c.189 1.444-1.564 2.578-2.784 1.839-1.375-.602-1.375-2.784-.034-3.403 1.151-.705 2.818.223 2.818 1.564zm1.907-.361c-.309-2.44-3.076-4.056-5.328-3.042-1.426.636-2.389 2.148-2.32 3.747.086 2.097 2.08 3.815 4.176 3.626s3.729-2.234 3.472-4.331zm4.108-9.315c-.756-.997-2.045-1.169-3.179-1.358-3.214-.516-6.513-.533-9.727.034-1.066.172-2.269.361-2.939 1.323 1.1 1.031 2.664 1.186 4.073 1.358 2.544.327 5.156.344 7.699.017 1.426-.172 3.008-.309 4.073-1.375zm.979 17.788c-.481 1.684-.206 3.953-1.994 4.932-3.076 1.701-6.806 1.89-10.191 1.289-1.787-.327-3.884-.894-4.864-2.578-.43-1.65-.705-3.334-.98-5.018l.103-.275.309-.155c5.121 3.386 12.288 3.386 17.427.0.808.241.206 1.22.189 1.805zM26.01 4.951c-.584 3.764-1.255 7.51-1.908 11.257-.189 1.1-1.255 1.719-2.148 2.183-3.214 1.615-6.96 1.89-10.483 1.512-2.389-.258-4.829-.894-6.771-2.389-.911-.705-.911-1.908-1.083-2.922-.602-3.523-1.289-7.046-1.719-10.604.206-1.547 1.942-2.217 3.231-2.698C6.848.654 8.686.362 10.508.19c3.884-.378 7.854-.241 11.618.859 1.341.395 2.784.945 3.695 2.097.412.533.275 1.203.189 1.805z"/></svg><svg viewBox="-7.27 -7.27 38.55 38.55" id="gdoc_bookmark" xmlns="http://www.w3.org/2000/svg"><path d="M15.268 4.392q.868.0 1.532.638t.664 1.506v17.463l-7.659-3.268-7.608 3.268V6.536q0-.868.664-1.506t1.532-.638h10.876zm4.34 14.144V4.392q0-.868-.638-1.532t-1.506-.664H6.537q0-.868.664-1.532T8.733.0h10.876q.868.0 1.532.664t.664 1.532v17.412z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_brightness_auto" xmlns="http://www.w3.org/2000/svg"><path d="M16.846 18.938h2.382L15.22 7.785h-2.44L8.772 18.938h2.382l.871-2.44h3.95zm7.087-9.062L27.999 14l-4.066 4.124v5.809h-5.809L14 27.999l-4.124-4.066H4.067v-5.809L.001 14l4.066-4.124V4.067h5.809L14 .001l4.124 4.066h5.809v5.809zm-11.385 4.937L14 10.282l1.452 4.531h-2.904z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_brightness_dark" xmlns="http://www.w3.org/2000/svg"><path d="M14 21.435q3.079.0 5.257-2.178T21.435 14t-2.178-5.257T14 6.565q-1.51.0-3.079.697 1.917.871 3.108 2.701T15.22 14t-1.191 4.037-3.108 2.701q1.568.697 3.079.697zm9.933-11.559L27.999 14l-4.066 4.124v5.809h-5.809L14 27.999l-4.124-4.066H4.067v-5.809L.001 14l4.066-4.124V4.067h5.809L14 .001l4.124 4.066h5.809v5.809z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_brightness_light" xmlns="http://www.w3.org/2000/svg"><path d="M14 21.435q3.079.0 5.257-2.178T21.435 14t-2.178-5.257T14 6.565 8.743 8.743 6.565 14t2.178 5.257T14 21.435zm9.933-3.311v5.809h-5.809L14 27.999l-4.124-4.066H4.067v-5.809L.001 14l4.066-4.124V4.067h5.809L14 .001l4.124 4.066h5.809v5.809L27.999 14z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_check" xmlns="http://www.w3.org/2000/svg"><path d="M8.885 20.197 25.759 3.323l2.24 2.24L8.885 24.677.0 15.792l2.24-2.24z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_check_circle_outline" xmlns="http://www.w3.org/2000/svg"><path d="M14 25.239q4.601.0 7.92-3.319T25.239 14 21.92 6.08 14 2.761 6.08 6.08 2.761 14t3.319 7.92T14 25.239zM14 0q5.784.0 9.892 4.108T28 14t-4.108 9.892T14 28t-9.892-4.108T0 14t4.108-9.892T14 0zm6.441 7.822 1.972 1.972-11.239 11.239L4.207 14l1.972-1.972 4.995 4.995z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_cloud_off" xmlns="http://www.w3.org/2000/svg"><path d="M9.023 10.5H7q-1.914.0-3.281 1.395t-1.367 3.309 1.367 3.281T7 19.852h11.375zM3.5 4.976l1.477-1.477L24.5 23.022l-1.477 1.477-2.352-2.297H6.999q-2.898.0-4.949-2.051t-2.051-4.949q0-2.844 1.969-4.867t4.758-2.133zm19.086 5.578q2.242.164 3.828 1.832T28 16.351q0 3.008-2.461 4.758l-1.695-1.695q1.805-.984 1.805-3.063.0-1.422-1.039-2.461t-2.461-1.039h-1.75v-.602q0-2.68-1.859-4.539t-4.539-1.859q-1.531.0-2.953.711l-1.75-1.695Q11.431 3.5 14.001 3.5q2.953.0 5.496 2.078t3.09 4.977z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_code" xmlns="http://www.w3.org/2000/svg"><path d="M9.917 24.5a1.75 1.75.0 10-3.501.001 1.75 1.75.0 003.501-.001zm0-21a1.75 1.75.0 10-3.501.001A1.75 1.75.0 009.917 3.5zm11.666 2.333a1.75 1.75.0 10-3.501.001 1.75 1.75.0 003.501-.001zm1.75.0a3.502 3.502.0 01-1.75 3.026c-.055 6.581-4.721 8.039-7.82 9.023-2.898.911-3.846 1.349-3.846 3.117v.474a3.502 3.502.0 011.75 3.026c0 1.932-1.568 3.5-3.5 3.5s-3.5-1.568-3.5-3.5c0-1.294.711-2.424 1.75-3.026V6.526A3.502 3.502.0 014.667 3.5c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5a3.502 3.502.0 01-1.75 3.026v9.06c.93-.456 1.914-.766 2.807-1.039 3.391-1.075 5.323-1.878 5.359-5.687a3.502 3.502.0 01-1.75-3.026c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_copy" xmlns="http://www.w3.org/2000/svg"><path d="M23.502 25.438V7.626H9.562v17.812h13.94zm0-20.315q1.013.0 1.787.745t.774 1.757v17.812q0 1.013-.774 1.787t-1.787.774H9.562q-1.013.0-1.787-.774t-.774-1.787V7.625q0-1.013.774-1.757t1.787-.745h13.94zM19.689.0v2.562H4.438v17.812H1.936V2.562q0-1.013.745-1.787T4.438.001h15.251z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_dangerous" xmlns="http://www.w3.org/2000/svg"><path d="M21.802 19.833 15.969 14l5.833-5.833-1.969-1.969L14 12.031 8.167 6.198 6.198 8.167 12.031 14l-5.833 5.833 1.969 1.969L14 15.969l5.833 5.833zM19.833.0 28 8.167v11.666L19.833 28H8.167L0 19.833V8.167L8.167.0h11.666z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_date" xmlns="http://www.w3.org/2000/svg"><path d="M27.192 28.844V11.192H4.808v17.652h22.384zm0-25.689q1.277.0 2.253.976t.976 2.253v22.459q0 1.277-.976 2.216t-2.253.939H4.808q-1.352.0-2.291-.901t-.939-2.253V6.385q0-1.277.939-2.253t2.291-.976h1.577V.001h3.23v3.155h12.769V.001h3.23v3.155h1.577zm-3.155 11.267v3.155h-3.23v-3.155h3.23zm-6.46.0v3.155h-3.155v-3.155h3.155zm-6.384.0v3.155h-3.23v-3.155h3.23z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_download" xmlns="http://www.w3.org/2000/svg"><path d="M2.866 28.209h26.269v3.79H2.866v-3.79zm26.268-16.925L16 24.418 2.866 11.284h7.493V.001h11.283v11.283h7.493z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_email" xmlns="http://www.w3.org/2000/svg"><path d="M28.845 9.615v-3.23L16 14.422 3.155 6.385v3.23L16 17.577zm0-6.46q1.277.0 2.216.977T32 6.385v19.23q0 1.277-.939 2.253t-2.216.977H3.155q-1.277.0-2.216-.977T0 25.615V6.385q0-1.277.939-2.253t2.216-.977h25.69z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_error_outline" xmlns="http://www.w3.org/2000/svg"><path d="M14 25.239q4.601.0 7.92-3.319T25.239 14 21.92 6.08 14 2.761 6.08 6.08 2.761 14t3.319 7.92T14 25.239zM14 0q5.784.0 9.892 4.108T28 14t-4.108 9.892T14 28t-9.892-4.108T0 14t4.108-9.892T14 0zm-1.38 6.967h2.761v8.413H12.62V6.967zm0 11.239h2.761v2.826H12.62v-2.826z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_fire" xmlns="http://www.w3.org/2000/svg"><path d="M17.689 21.998q-.32.32-.8.576t-.864.384q-1.152.384-2.272.032t-1.888-.992q-.128-.128-.096-.256t.16-.192q1.216-.384 1.92-1.216t.96-1.792q.192-.896-.064-1.728t-.384-1.728q-.128-.704-.096-1.376t.288-1.312q0-.128.128-.128t.192.064q.384.832.992 1.472t1.28 1.216 1.216 1.248.672 1.568q.064.384.064.704.064.96-.32 1.92t-1.088 1.536zm3.84-10.944q-.768-.704-1.6-1.28t-1.6-1.344q-1.536-1.536-2.016-3.584t.16-4.16q.128-.32-.096-.544t-.544-.096q-.768.32-1.44.768t-1.312.896q-1.984 1.664-3.136 3.936T8.633 10.51t.8 5.088q0 .128.032.256t.032.256q0 .576-.512.832t-1.024-.192q-.128-.192-.192-.32-1.024-1.28-1.376-2.912t-.096-3.232q.064-.384-.288-.576t-.608.128q-1.28 1.664-1.856 3.68t-.448 4.064q0 .576.096 1.184t.288 1.184q.448 1.536 1.216 2.816 1.216 2.048 3.264 3.424t4.416 1.696q2.496.32 5.024-.256t4.448-2.304q1.408-1.344 2.208-3.104t.864-3.68-.704-3.712q-.064-.128-.096-.224t-.096-.224q-.576-1.088-1.28-1.984-.256-.384-.544-.704t-.672-.64z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_git" xmlns="http://www.w3.org/2000/svg"><path d="M27.472 12.753 15.247.529a1.803 1.803.0 00-2.55.0l-2.84 2.84 2.137 2.137a2.625 2.625.0 013.501 3.501l3.499 3.499a2.625 2.625.0 11-1.237 1.237l-3.499-3.499c-.083.04-.169.075-.257.106v7.3a2.626 2.626.0 11-1.75.0v-7.3a2.626 2.626.0 01-1.494-3.607L8.62 4.606l-8.09 8.09a1.805 1.805.0 000 2.551l12.225 12.224a1.803 1.803.0 002.55.0l12.168-12.168a1.805 1.805.0 000-2.551z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_github" xmlns="http://www.w3.org/2000/svg"><path d="M16 .394c8.833.0 15.999 7.166 15.999 15.999.0 7.062-4.583 13.062-10.937 15.187-.813.146-1.104-.354-1.104-.771.0-.521.021-2.25.021-4.396.0-1.5-.5-2.458-1.083-2.958 3.562-.396 7.312-1.75 7.312-7.896.0-1.75-.625-3.167-1.646-4.291.167-.417.708-2.042-.167-4.25-1.333-.417-4.396 1.646-4.396 1.646a15.032 15.032.0 00-8 0S8.937 6.602 7.603 7.018c-.875 2.208-.333 3.833-.167 4.25-1.021 1.125-1.646 2.542-1.646 4.291.0 6.125 3.729 7.5 7.291 7.896-.458.417-.875 1.125-1.021 2.146-.917.417-3.25 1.125-4.646-1.333-.875-1.521-2.458-1.646-2.458-1.646-1.562-.021-.104.979-.104.979 1.042.479 1.771 2.333 1.771 2.333.938 2.854 5.396 1.896 5.396 1.896.0 1.333.021 2.583.021 2.979.0.417-.292.917-1.104.771C4.582 29.455-.001 23.455-.001 16.393-.001 7.56 7.165.394 15.998.394zM6.063 23.372c.042-.083-.021-.187-.146-.25-.125-.042-.229-.021-.271.042-.042.083.021.187.146.25.104.062.229.042.271-.042zm.646.709c.083-.062.062-.208-.042-.333-.104-.104-.25-.146-.333-.062-.083.062-.062.208.042.333.104.104.25.146.333.062zm.625.937c.104-.083.104-.25.0-.396-.083-.146-.25-.208-.354-.125-.104.062-.104.229.0.375s.271.208.354.146zm.875.875c.083-.083.042-.271-.083-.396-.146-.146-.333-.167-.417-.062-.104.083-.062.271.083.396.146.146.333.167.417.062zm1.187.521c.042-.125-.083-.271-.271-.333-.167-.042-.354.021-.396.146s.083.271.271.312c.167.062.354.0.396-.125zm1.313.104c0-.146-.167-.25-.354-.229-.187.0-.333.104-.333.229.0.146.146.25.354.229.187.0.333-.104.333-.229zm1.208-.208c-.021-.125-.187-.208-.375-.187-.187.042-.312.167-.292.312.021.125.187.208.375.167s.312-.167.292-.292z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_gitlab" xmlns="http://www.w3.org/2000/svg"><path d="M1.629 11.034 14 26.888.442 17.048a1.09 1.09.0 01-.39-1.203l1.578-4.811zm7.217.0h10.309l-5.154 15.854zM5.753 1.475l3.093 9.559H1.63l3.093-9.559a.548.548.0 011.031.0zm20.618 9.559 1.578 4.811c.141.437-.016.922-.39 1.203l-13.558 9.84 12.371-15.854zm0 0h-7.216l3.093-9.559a.548.548.0 011.031.0z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_heart" xmlns="http://www.w3.org/2000/svg"><path d="M16 29.714a1.11 1.11.0 01-.786-.321L4.072 18.643c-.143-.125-4.071-3.714-4.071-8 0-5.232 3.196-8.357 8.535-8.357 3.125.0 6.053 2.464 7.464 3.857 1.411-1.393 4.339-3.857 7.464-3.857 5.339.0 8.535 3.125 8.535 8.357.0 4.286-3.928 7.875-4.089 8.035L16.785 29.392c-.214.214-.5.321-.786.321z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_home" xmlns="http://www.w3.org/2000/svg"><path d="M24.003 15.695v8.336c0 .608-.504 1.111-1.111 1.111h-6.669v-6.669h-4.446v6.669H5.108a1.119 1.119.0 01-1.111-1.111v-8.336c0-.035.017-.069.017-.104L14 7.359l9.986 8.232a.224.224.0 01.017.104zm3.873-1.198-1.077 1.285a.578.578.0 01-.365.191h-.052a.547.547.0 01-.365-.122L14 5.831 1.983 15.851a.594.594.0 01-.417.122.578.578.0 01-.365-.191L.124 14.497a.57.57.0 01.069-.781L12.679 3.314c.729-.608 1.91-.608 2.64.0l4.237 3.543V3.471c0-.313.243-.556.556-.556h3.334c.313.0.556.243.556.556v7.085l3.803 3.161c.226.191.26.556.069.781z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_info_outline" xmlns="http://www.w3.org/2000/svg"><path d="M12.62 9.793V6.967h2.761v2.826H12.62zM14 25.239q4.601.0 7.92-3.319T25.239 14 21.92 6.08 14 2.761 6.08 6.08 2.761 14t3.319 7.92T14 25.239zM14 0q5.784.0 9.892 4.108T28 14t-4.108 9.892T14 28t-9.892-4.108T0 14t4.108-9.892T14 0zm-1.38 21.033V12.62h2.761v8.413H12.62z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_keyboard_arrow_down" xmlns="http://www.w3.org/2000/svg"><path d="M3.281 5.36 14 16.079 24.719 5.36 28 8.641l-14 14-14-14z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_keyboard_arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M25.875 28.25 22.125 32 6.126 16.001 22.125.002l3.75 3.75-12.25 12.25z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_keyboard_arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M6.125 28.25 18.375 16 6.125 3.75 9.875.0l15.999 15.999L9.875 31.998z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_keyboard_arrow_up" xmlns="http://www.w3.org/2000/svg"><path d="M24.719 22.64 14 11.921 3.281 22.64.0 19.359l14-14 14 14z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_language" xmlns="http://www.w3.org/2000/svg"><path d="M20.112 16.826h4.732q.394-1.84.394-2.826t-.394-2.826h-4.732q.197 1.38.197 2.826t-.197 2.826zm-2.497 7.756q1.643-.526 3.418-2.005t2.695-2.991h-4.141q-.657 2.629-1.972 4.995zm-.329-7.756q.197-1.38.197-2.826t-.197-2.826h-6.573q-.197 1.38-.197 2.826t.197 2.826h6.573zM14 25.173q1.84-2.695 2.695-5.587h-5.39q.854 2.892 2.695 5.587zM8.413 8.413q.789-2.826 1.972-4.995-1.643.526-3.451 2.005T4.272 8.414h4.141zM4.272 19.587q.854 1.512 2.662 2.991t3.451 2.005q-1.315-2.366-1.972-4.995H4.272zm-1.117-2.761h4.732Q7.69 15.446 7.69 14t.197-2.826H3.155q-.394 1.84-.394 2.826t.394 2.826zM14 2.826q-1.84 2.695-2.695 5.587h5.39Q15.841 5.521 14 2.826zm9.727 5.587q-.92-1.512-2.695-2.991t-3.418-2.005q1.183 2.169 1.972 4.995h4.141zM14 0q5.784.0 9.892 4.108T28 14t-4.108 9.892T14 28t-9.892-4.108T0 14t4.108-9.892T14 0z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_link" xmlns="http://www.w3.org/2000/svg"><path d="M24.037 7.963q3.305.0 5.634 2.366T32 16t-2.329 5.671-5.634 2.366h-6.46v-3.08h6.46q2.028.0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.08h6.46zM9.615 17.578v-3.155h12.77v3.155H9.615zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.08h-6.46q-3.305.0-5.634-2.366T0 16.001t2.329-5.671 5.634-2.366h6.46v3.08h-6.46q-2.028.0-3.493 1.465t-1.465 3.493z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_menu" xmlns="http://www.w3.org/2000/svg"><path d="M.001 5.334h31.998v3.583H.001V5.334zm0 12.416v-3.5h31.998v3.5H.001zm0 8.916v-3.583h31.998v3.583H.001z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_notification" xmlns="http://www.w3.org/2000/svg"><path d="M22.615 19.384l2.894 2.894v1.413H2.49v-1.413l2.894-2.894V12.25q0-3.365 1.716-5.856t4.745-3.231v-1.01q0-.875.606-1.514T13.999.0t1.548.639.606 1.514v1.01q3.029.74 4.745 3.231t1.716 5.856v7.134zM14 27.999q-1.211.0-2.053-.808t-.841-2.019h5.788q0 1.144-.875 1.986T14 27.999z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_path" xmlns="http://www.w3.org/2000/svg"><path d="M28 12.62h-9.793V8.414h-2.826v11.173h2.826v-4.206H28V26.62h-9.793v-4.206H12.62v-14H9.794v4.206H.001V1.381h9.793v4.206h8.413V1.381H28V12.62z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_person" xmlns="http://www.w3.org/2000/svg"><path d="M16 20.023q5.052.0 10.526 2.199t5.473 5.754v4.023H0v-4.023q0-3.555 5.473-5.754t10.526-2.199zM16 16q-3.275.0-5.614-2.339T8.047 8.047t2.339-5.661T16 0t5.614 2.386 2.339 5.661-2.339 5.614T16 16z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_search" xmlns="http://www.w3.org/2000/svg"><path d="M11.925 20.161q3.432.0 5.834-2.402t2.402-5.834-2.402-5.834-5.834-2.402-5.834 2.402-2.402 5.834 2.402 5.834 5.834 2.402zm10.981.0L32 29.255 29.255 32l-9.094-9.094v-1.458l-.515-.515q-3.26 2.831-7.721 2.831-4.976.0-8.45-3.432T.001 11.925t3.474-8.45 8.45-3.474 8.407 3.474 3.432 8.45q0 1.802-.858 4.075t-1.973 3.646l.515.515h1.458z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_shield" xmlns="http://www.w3.org/2000/svg"><path d="M22.167 15.166V3.5h-8.166v20.726c.93-.492 2.424-1.349 3.883-2.497 1.95-1.531 4.284-3.919 4.284-6.562zm3.499-13.999v14c0 7.674-10.737 12.523-11.192 12.724-.146.073-.31.109-.474.109s-.328-.036-.474-.109c-.456-.201-11.192-5.049-11.192-12.724v-14C2.334.529 2.863.0 3.501.0H24.5c.638.0 1.167.529 1.167 1.167z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_star" xmlns="http://www.w3.org/2000/svg"><path d="M14 22.052 5.324 27.31l2.3-9.859L0 10.813l10.056-.854L14 .692l3.944 9.267L28 10.813l-7.624 6.638 2.3 9.859z"/></svg><svg viewBox="-7.27 -7.27 42.55 42.55" id="gdoc_tag" xmlns="http://www.w3.org/2000/svg"><path d="M17.52 17.52v-7.041h-7.041v7.041h7.041zM28 10.479h-7.041v7.041H28v3.439h-7.041V28H17.52v-7.041h-7.041V28H7.04v-7.041H-.001V17.52H7.04v-7.041H-.001V7.04H7.04V-.001h3.439V7.04h7.041V-.001h3.439V7.04H28v3.439z"/></svg><svg viewBox="-7.27 -7.27 46.55 46.55" id="gdoc_timer" xmlns="http://www.w3.org/2000/svg"><path d="M16 29q4.428.0 7.536-3.143t3.107-7.571-3.107-7.536T16 7.643 8.464 10.75t-3.107 7.536 3.107 7.571T16 29zM26.714 9.786q1.214 1.571 2.107 4.036t.893 4.464q0 5.643-4 9.678T16 32t-9.714-4.036-4-9.678 4-9.678T16 4.572q1.929.0 4.464.929t4.107 2.143l2.143-2.214q1.143.929 2.143 2.143zM14.5 19.857v-9.143h3v9.143h-3zM20.571.001v3.071h-9.143V.001h9.143z"/></svg></defs></svg><div class="wrapper dark-mode-dim"><input type=checkbox class=hidden id=menu-control>
<input type=checkbox class=hidden id=menu-header-control><header class=gdoc-header><div class="container flex align-center justify-between"><label for=menu-control class=gdoc-nav__control tabindex=0><svg class="gdoc-icon gdoc_menu"><title>Open Navigation</title><use xlink:href="#gdoc_menu"/></svg><svg class="gdoc-icon gdoc_arrow_back"><title>Close Navigation</title><use xlink:href="#gdoc_arrow_back"/></svg></label><div><a class="gdoc-brand gdoc-header__link" href=https://ab0x90.github.io><span class="flex align-center"><img class=gdoc-brand__img src=/brand.svg alt>
<span class=gdoc-brand__title>Offensive Playbook</span></span></a></div><div class=gdoc-menu-header><span class=gdoc-menu-header__items><span id=gdoc-color-theme><svg class="gdoc-icon gdoc_brightness_dark"><title>Toggle Dark/Light/Auto mode</title><use xlink:href="#gdoc_brightness_dark"/></svg><svg class="gdoc-icon gdoc_brightness_light"><title>Toggle Dark/Light/Auto mode</title><use xlink:href="#gdoc_brightness_light"/></svg><svg class="gdoc-icon gdoc_brightness_auto"><title>Toggle Dark/Light/Auto mode</title><use xlink:href="#gdoc_brightness_auto"/></svg></span><span class=gdoc-menu-header__home><a href=https://ab0x90.github.io class=gdoc-header__link><svg class="gdoc-icon gdoc_home"><title>Back to homepage</title><use xlink:href="#gdoc_home"/></svg></a></span><span class=gdoc-menu-header__control><label for=menu-header-control><svg class="gdoc-icon gdoc_keyboard_arrow_right"><use xlink:href="#gdoc_keyboard_arrow_right"/><title>Close Menu Bar</title></svg></label></span></span><label for=menu-header-control class=gdoc-menu-header__control><svg class="gdoc-icon gdoc_keyboard_arrow_left"><use xlink:href="#gdoc_keyboard_arrow_left"/><title>Open Menu Bar</title></svg></label></div></div></header><main class="container flex flex-even"><aside class=gdoc-nav><nav><section class=gdoc-nav--main><h2>Navigation</h2><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><svg class="gdoc-icon gdoc_tag"><use xlink:href="#gdoc_tag"/></svg><a href=/Active_Directory/Active_Directory/ class=gdoc-nav__entry>Active Directory</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Download_and_Execute/ class=gdoc-nav__entry>Download and Execute Methods</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Reverse_Shells/ class=gdoc-nav__entry>Reverse Shells</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Initial_Attack_Vectors/Initial_Attacks/ class=gdoc-nav__entry>Inital Attacks</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Initial_Attack_Vectors/LLMNR/ class=gdoc-nav__entry>LLMNR Poisoning</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Initial_Attack_Vectors/Relay_Attacks/ class=gdoc-nav__entry>Relay Attacks</a></span></label></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Active_Directory_Enumeration/ class=gdoc-nav__entry>AD Enumeration</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/CrackMapExec/ class=gdoc-nav__entry>CrackMapExec</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/PowerShell_Port_Scanner/ class=gdoc-nav__entry>PowerShell Port Scanner</a></span></label></li><li></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Service_Exploitation/Service_Exploitation/ class=gdoc-nav__entry>Service Exploitation</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Service_Exploitation/RDP/ class=gdoc-nav__entry>RDP</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Service_Exploitation/SMB/ class=gdoc-nav__entry>SMB</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Service_Exploitation/WinRM/ class=gdoc-nav__entry>WinRM</a></span></label></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Lateral_Movement/ class=gdoc-nav__entry>Lateral Movement</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Persistence/Domain_Persistence/ class=gdoc-nav__entry>Domain Persistence</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Persistence/Golden_Ticket/ class=gdoc-nav__entry>Golden Ticket</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Persistence/Silver_Ticket/ class=gdoc-nav__entry>Silver Ticket</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Persistence/Skeleton_Key/ class=gdoc-nav__entry>Skeleton Key</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Persistence/Directory_Services_Restore_Mode/ class=gdoc-nav__entry>DSRM</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Persistence/acls/ class=gdoc-nav__entry>ACLs</a></span></label></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/bypasses/ class=gdoc-nav__entry>Bypasses</a></span></label><ul class=gdoc-nav__list><li></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Privilege_Escalation/ class=gdoc-nav__entry>Privilege Escalation</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/ class="gdoc-nav__entry is-active">ADCS</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Certificate_Theft/ class=gdoc-nav__entry>Certificate Theft</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Certificate_Persistence/ class=gdoc-nav__entry>Certificate Persistence</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Certificate_Privilege_Escalation/ class=gdoc-nav__entry>Privilege Escalation via Certificates</a></span></label></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Rights_Abuse/ class=gdoc-nav__entry>Rights Abuse</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/PowerUp/ class=gdoc-nav__entry>PowerUp</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Invoke-Mimikatz/ class=gdoc-nav__entry>Invoke-Mimikatz</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Kerberoast/ class=gdoc-nav__entry>Kerberoast</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Kerberos_Delegation/ class=gdoc-nav__entry>Kerberos Delegation</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/DNS_Admins/ class=gdoc-nav__entry>DNS Admins</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/Trust_Abuse/ class=gdoc-nav__entry>Trust Abuse</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Active_Directory/Priv_Esc/MSSQL_Servers/ class=gdoc-nav__entry>MSSQL Servers</a></span></label></li></ul></li></ul></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Enumeration/Enumeration/ class=gdoc-nav__entry>Enumeration</a></span></label><ul class=gdoc-nav__list><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Enumeration/by_port/ class=gdoc-nav__entry>By Port</a></span></label></li><li><input type=checkbox class=hidden>
<label><span class=flex><a href=/Enumeration/by_service/ class=gdoc-nav__entry>By Service</a></span></label></li></ul></li></ul></section><section class=gdoc-nav--more></section></nav></aside><div class=gdoc-page><div class="gdoc-page__header flex flex-wrap
justify-end
hidden-mobile
hidden" itemprop=breadcrumb></div><article class="gdoc-markdown gdoc-markdown__align--left"><h1>Active Directory Certificate Services</h1><div class=gdoc-page__anchorwrap><h1 id=adcs-information>ADCS Information
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#adcs-information class="gdoc-page__anchor clip flex align-center" title="Anchor to: ADCS Information" aria-label="Anchor to: ADCS Information" href=#adcs-information><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h1></div><p>These notes are mainly summarized from the Specterops paper linked below.
<a class=gdoc-markdown__link href=https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf>https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf</a></p><p><a class=gdoc-markdown__link href=https://tryhackme.com/room/adcertificatetemplates>https://tryhackme.com/room/adcertificatetemplates</a></p><p>ADCS is Microsoft&rsquo;s PKI implementation. ADCS is used for several things such as encrypting file systems, creating and verifying digital signatures, and even user authentication. What makes ADCS a good attack vector is that these certificates survive credential rotation. If a compromised account&rsquo;s password is reset or the system reimaged, the attacker created certificate would still be valid providing persistence.</p><p>The image below shows the process for certificate generation, taken from the specterops whitepaper.</p><p><img src=/images/cs1.png alt></p><p>ADCS is a privileged function and usually only runs on select DCs. To mitigate the workload of an Admin creating and distributing certificates manually, certificate templates can be created for use. These templates have parameters that specify which users can request a certificate and what is required for it. Detailed in the specterops paper, it has been found that configurations of ADCS can be abused for privilege escalation and persistent access.</p><div class=gdoc-page__anchorwrap><h2 id=certificate-breakdown>Certificate Breakdown
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#certificate-breakdown class="gdoc-page__anchor clip flex align-center" title="Anchor to: Certificate Breakdown" aria-label="Anchor to: Certificate Breakdown" href=#certificate-breakdown><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>A certificate is x.509 formatted and contains the following information:</p><ol><li>Subject - owner of the cert</li><li>Public Key - associates the subject with a private key stored seperately</li><li>NotBefore and NotAfter - duration of the cert</li><li>Serial Number - ID for the cert assigned by the CA</li><li>Issuer - who issued the cert (CA)</li><li>SubjectAlternativeName - defines one or more alternate names that the subject may go by</li><li>Basic Constraints - identifies whether the cert is assigned to a CA or end entity and if there are any contraints</li><li>Extended Key Usages (EKUs) - OID that describe how the cert will be used. Some commone OIDs:<ul><li>Code Signing (OID 1.3.6.1.5.5.7.3.3) - for signing executable code</li><li>Encrypting File System (OID 1.3.6.1.4.1.311.10.3.4) - for encrypting file systems</li><li>Secure Email (1.3.6.1.5.5.7.3.4) - encrypting email</li><li>Client Authentication (OID 1.3.6.1.5.5.7.3.2) - authentication to another server</li><li>Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2) - for use in smart card authentiation</li><li>Server Authentication (OID 1.3.6.1.5.5.7.3.1) - for identifying servers (HTTPS Certificates)</li></ul></li><li>Signature Algorithm - specifies the algorithm used to sign the cert</li><li>Signature - signature of the certificates body, made using the issuer&rsquo;s private key</li></ol><p>The CA first creates its own public-private key pair and generates a self signed certificate to use for issuing certificates. Properties of a CA cert is Subject and Issuer are both the CA&rsquo;s name, Basic Constraints are Subject Type=CA and NotBefore/NotAfter are set to 5 years by default.</p><div class=gdoc-page__anchorwrap><h2 id=certificate-locations>Certificate Locations
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#certificate-locations class="gdoc-page__anchor clip flex align-center" title="Anchor to: Certificate Locations" aria-label="Anchor to: Certificate Locations" href=#certificate-locations><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>There are four locations under the container CN=Public Key Services,CN=Services,CN=Configuration,DC=<domain>,DC=<com></p><ol><li>Certification Authorities - defines trusted root CA certs. For ADCS to consider a cert to be trusted, the cert chain must end with a root CA defined here. The following attributes are applied to these:<ul><li>objectClass is set to certificationAuthority</li><li>cACertificate property containes the bytes of the CA&rsquo;s certificate</li></ul></li><li>Enrollment Services - container defines Enterprise CAs. In an AD environment a client would interact with the Enterprise CA to request a cert. Every enterprise CA has an AD object containing the following attributes:<ul><li>objectClass set to pKIEnrollmentService</li><li>cACertificate containing the bytes of the CA&rsquo;s certificate</li><li>dNSHostName sets the DNS host of the CA</li><li>Certificate Templates field defining the enables templates</li></ul></li><li>NTAuthCertificates - This container defines CA certificates that enable authentication to AD. This AD object has the following properties:<ul><li>objectClass is set to certificationAuthority</li><li>cACertificate defines an array of trusted CA certs</li></ul></li><li>AIA (Authority Information Access) - this container holds AD objects of intermediate and cross CAs (intermediate = children of root CAs).<ul><li>objectClass is set to certificationAuthority</li><li>cACertificate property containes the bytes of the CA&rsquo;s certificate</li></ul></li></ol><div class=gdoc-page__anchorwrap><h2 id=ekus-that-allow-authentication>EKUs That Allow Authentication
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#ekus-that-allow-authentication class="gdoc-page__anchor clip flex align-center" title="Anchor to: EKUs That Allow Authentication" aria-label="Anchor to: EKUs That Allow Authentication" href=#ekus-that-allow-authentication><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><ol><li>Client Authentication - 1.3.6.1.5.5.7.3.2</li><li>PKINIT Client Authentication (not enabled by default) - 1.3.6.1.5.2.3.4</li><li>Smart Card Logon - 1.3.6.1.4.1.311.20.2.2</li><li>Any Purpose - 2.5.29.37.0</li><li>SubCA - (no EKUs)</li></ol><div class=gdoc-page__anchorwrap><h2 id=enrollment-rights>Enrollment Rights
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#enrollment-rights class="gdoc-page__anchor clip flex align-center" title="Anchor to: Enrollment Rights" aria-label="Anchor to: Enrollment Rights" href=#enrollment-rights><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>Enrollment rights in ADCS are defined by two security descriptors: one on the certificate template and one on the Enterprice CA.</p><p>The following ACEs within a templates DACL will allow a principal enrollment rights:</p><ol><li>Certificate Enrollment extended right - The raw ACE grants a principal RIGHT_DS_CONTROL_ACCESS where the Object Type is set to 0e10c968-78fb-11d2-90d4-00c04f79dc55</li><li>Certificate-AutoEnrollment extended right - The raw ACE grants a principal RIGHT_DS_CONTROL_ACCESS where the Object Type is set to 05b8cc2 -17bc-4802-a710-e7c15ab866a2</li><li>All ExtendedRights - The raw ACE grants a principal RIGHT_DS_CONTROL_ACCESS where the Object Type is set to 0000000-
0000-0000-0000-000000000000</li><li>FullControl/GenericAll</li></ol><p>The Enterprise CA also stores these, but supersedes the certificate templates.</p><div class=gdoc-page__anchorwrap><h2 id=subject-alternative-names-and-authentication>Subject Alternative Names and Authentication
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#subject-alternative-names-and-authentication class="gdoc-page__anchor clip flex align-center" title="Anchor to: Subject Alternative Names and Authentication" aria-label="Anchor to: Subject Alternative Names and Authentication" href=#subject-alternative-names-and-authentication><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>SANs are a way to specify an additional identity to be bound to a certificate. Example being a web server that hosts multiple domains. One certificate would be suffecient for this server by specifying the other domains in the SAN. This ability being combined with domain authentication is dangerous. Taken from the specterops paper:</p><p><code>By default, during certificate-based authentication, one way AD maps certificates to user accounts based on a UPN specified in the SAN. If an attacker can specify an arbitrary SAN when requesting a certificate that has an EKU enabling client authentication, and the CA creates and signs a certificate using the attacker-supplied SAN, the attacker can become any user in the domain.</code></p><div class=gdoc-page__anchorwrap><h1 id=certificate-theft>Certificate Theft
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#certificate-theft class="gdoc-page__anchor clip flex align-center" title="Anchor to: Certificate Theft" aria-label="Anchor to: Certificate Theft" href=#certificate-theft><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h1></div><div class=gdoc-page__anchorwrap><h2 id=theft1---exporting-certificates-using-crypto-apis>Theft1 - Exporting Certificates Using Crypto APIs
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#theft1---exporting-certificates-using-crypto-apis class="gdoc-page__anchor clip flex align-center" title="Anchor to: Theft1 - Exporting Certificates Using Crypto APIs" aria-label="Anchor to: Theft1 - Exporting Certificates Using Crypto APIs" href=#theft1---exporting-certificates-using-crypto-apis><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>This method involves using an interactive desktop session to export the certificate. Right click the certificate in certmgr.msc go to all tasks and export it. This will export a password protected .pfx file. In the case the private keys are not exportable, mimikatz has a couple modules which would patch Microsoft&rsquo;s CryptoAPI (CAPI) or more recent Cryptography API: Next Generation (CNG), allowing the export of private keys. The CAPI command will patch CAPI in the current process whereas CNG requires patching lsass&rsquo;s memory, which can be detected.</p><pre tabindex=0><code>mimikatz
crypto::capi
crypto:cng
</code></pre><div class=gdoc-page__anchorwrap><h2 id=theft2---user-certficate-theft-using-dpapi>Theft2 - User Certficate Theft Using DPAPI
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#theft2---user-certficate-theft-using-dpapi class="gdoc-page__anchor clip flex align-center" title="Anchor to: Theft2 - User Certficate Theft Using DPAPI" aria-label="Anchor to: Theft2 - User Certficate Theft Using DPAPI" href=#theft2---user-certficate-theft-using-dpapi><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>This method involves using both mimikatz and sharpDPAPI, or just SharpDPAPI. Essentially we need to steal the master key and use this to decrypt the private keys and associated certificates.</p><p>User certificates are commonly stored in the following locations:</p><pre tabindex=0><code>HKEY_CURRENT_USER\SOFTWARE\Microsoft\SystemCertificates
%APPDATA%\Microsoft\SystemCertificates\My\Certificates\
</code></pre><p>The user private key are commonly stored in the following locations:</p><pre tabindex=0><code>%APPDATA%\Microsoft\Crypto\RSA\User SID\
%APPDATA%\Microsoft\Crypto\Keys\
</code></pre><p>For a compromised user mimikatz can be used to retrieve the masterkey. This must be run in the security context of the user.</p><pre tabindex=0><code>mimikatz
dpapi::masterkey /in:&#34;C:\path\to\key&#34;
</code></pre><p>If a password is known for a user, mimikatz can also retrieve the masterkey for this user.</p><pre tabindex=0><code>mimikatz
dpapi::masterkey /in:&#34;C:\path\to\key&#34; /sid:accountsid /password:userpassword
</code></pre><p>SharpDPAPI can be used alongside this created masterkey file, the private key itself, or the password of the user.</p><pre tabindex=0><code>sharpDPAPI.exe certificates /mkfile:C:\temp\mkeys.txt
</code></pre><p>This command outputs a .pemfile and an openssl command at the end which can be used to convert it to a .pfx file.</p><div class=gdoc-page__anchorwrap><h2 id=theft3---machine-certificate-theft-using-dpapi>Theft3 - Machine Certificate Theft Using DPAPI
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#theft3---machine-certificate-theft-using-dpapi class="gdoc-page__anchor clip flex align-center" title="Anchor to: Theft3 - Machine Certificate Theft Using DPAPI" aria-label="Anchor to: Theft3 - Machine Certificate Theft Using DPAPI" href=#theft3---machine-certificate-theft-using-dpapi><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>This is similar to Theft2, but instead using machine accounts. Both mimikatz and ShaprDPAPI can be used here, but sharpDPAPI is better. This also needs to be done from an elevated prompt.</p><p>With mimikatz the CAPI and CNG must be patched, same method as before in Theft1. After we can use the following command to export:</p><pre tabindex=0><code>mimikatz
crypto::certificates /export /systemstore:LOCAL_MACHINE
</code></pre><p>SharpDPAPI has a certificates command that basically does everything all for us. From the specterops paper:</p><p><code>SharpDPAPI’s certificates command with the /machine flag (while elevated) will automatically elevate to SYSTEM, dump the DPAPI_SYSTEM LSA secret, use this to decrypt and found machine DPAPI masterkeys, and use the key plaintexts as a lookup table to decrypt any machine certificate private keys</code></p><div class=gdoc-page__anchorwrap><h2 id=theft4---finding-certificate-files>Theft4 - Finding Certificate Files
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#theft4---finding-certificate-files class="gdoc-page__anchor clip flex align-center" title="Anchor to: Theft4 - Finding Certificate Files" aria-label="Anchor to: Theft4 - Finding Certificate Files" href=#theft4---finding-certificate-files><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>It is possible for certificate files and their private keys to be stored insecurely, without the need for extracting them. Common file types are: .pem, .pfx, .p12 and .pkcs12 (less often). Other potential interesting files related to certificates are:</p><ol><li>.key - contains private key</li><li>.crt/.cer - contains the certificate</li><li>.csr - certificate signing requiest file</li><li>.jks/.keystore/.keys - java keystore, may contain certs and private keys if java applications use them</li></ol><p>Any file searching method will work for discovering these.</p><pre tabindex=0><code>dir C:\ 10 \.(pfx|pem|p12)`$ false
</code></pre><p>Regarding a PKCS#12 file, if it is password protected pfx2john can be used to extract a hash.</p><p>If these files are found, the next step is understanding what EKUs are associated with the certificate, in other words what can the certificate do? The following powershell can be used to discover the EKUs for a certificate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$CertPath</span> <span class=p>=</span> <span class=err>“</span><span class=n>C:</span><span class=p>\</span><span class=n>path</span><span class=p>\</span><span class=n>to</span><span class=p>\</span><span class=n>cert</span><span class=p>.</span><span class=n>pfx</span><span class=err>”</span>
</span></span><span class=line><span class=cl><span class=nv>$CertPass</span> <span class=p>=</span> <span class=err>“</span><span class=n>P</span><span class=nv>@ssw0rd</span><span class=err>”</span>
</span></span><span class=line><span class=cl><span class=nv>$Cert</span> <span class=p>=</span> <span class=nb>New-Object</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=p>.</span><span class=n>Security</span><span class=p>.</span><span class=n>Cryptography</span><span class=p>.</span><span class=n>X509Certificates</span><span class=p>.</span><span class=n>X509Certificate2</span>
</span></span><span class=line><span class=cl><span class=p>@(</span><span class=nv>$CertPath</span><span class=p>,</span> <span class=nv>$CertPass</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$Cert</span><span class=p>.</span><span class=n>EnhancedKeyUsageList</span>
</span></span></code></pre></div><p>Certutil can also be used to parse a .pfx file</p><pre tabindex=0><code>certutil.exe -dump -v cert.pfx
</code></pre><p>There is also small chance that a CA certificate file itself might be discoverd. The specterops paper showed the following image which displays how to identify this, using 3 different tools.</p><p><img src=/images/cs3.png alt></p><div class=gdoc-page__anchorwrap><h2 id=theft5---ntlm-credential-theft-via-pkinit>Theft5 - NTLM Credential Theft via PKINIT
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#theft5---ntlm-credential-theft-via-pkinit class="gdoc-page__anchor clip flex align-center" title="Anchor to: Theft5 - NTLM Credential Theft via PKINIT" aria-label="Anchor to: Theft5 - NTLM Credential Theft via PKINIT" href=#theft5---ntlm-credential-theft-via-pkinit><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>If an account authenticates and is granted a TGT through PKINIT, it is possible to extract the NTLM hash from the TGT. This is done to support legacy authentication on applications that do not support kerberos.</p><p>Kekeo has a way to do this:</p><pre tabindex=0><code>kekeo
tgt::pac /caname:DC01 /subject:harmj0y(current user) /castore:current_user /domain:domain.local
</code></pre><div class=gdoc-page__anchorwrap><h1 id=account-persistence>Account Persistence
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#account-persistence class="gdoc-page__anchor clip flex align-center" title="Anchor to: Account Persistence" aria-label="Anchor to: Account Persistence" href=#account-persistence><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h1></div><div class=gdoc-page__anchorwrap><h2 id=persist1---active-user-credential-theft-via-certificates>Persist1 - Active User Credential Theft via Certificates
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#persist1---active-user-credential-theft-via-certificates class="gdoc-page__anchor clip flex align-center" title="Anchor to: Persist1 - Active User Credential Theft via Certificates" aria-label="Anchor to: Persist1 - Active User Credential Theft via Certificates" href=#persist1---active-user-credential-theft-via-certificates><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div><p>If an enterprise CA does exist a user can request a certificate for any template available to them for enrollment. The template must have the following properties:</p><ol><li>published for enrollment</li><li>domain users are allowed to enroll</li><li>has any of the following EKUs<ul><li>Smart Card Logon (1.3.6.1.4.1.311.20.2.2)</li><li>Client Authentication (1.3.6.1.5.5.7.3.2)</li><li>PKINIT Client Authentication (1.3.6.1.5.2.3.4)</li><li>Any Purpose EKU (2.5.29.37.0)</li><li>No EKU set. i.e., this is a (subordinate) CA certificate.</li></ul></li><li>does not require manager approval or authorized signatures</li></ol><p>There is a &ldquo;User&rdquo; template which is a stock template that allows this. It is enabled by default.</p><p>Using Certify with the /clientauth command will show all available templates to the user with these parameters.</p><pre tabindex=0><code>Certify.exe /clientauth
</code></pre><p>If GUI access is available, we can manually request a certificate through certmgr.msc or certreq.exe. Certify can also be used to enroll the current user in a new certificat template.</p><pre tabindex=0><code>Certify.exe request /ca:CA_SERVER\CA-NAME /template:template-name
Certify.exe request /ca:dc01.domain.local\dc01-CA /template:User
</code></pre><p>This will output a .pem file, openssl can be used to transfer this to a .pfx. The .pfx can be transferred to a target and used with Rubeus to request a TGT for the enrolled user.</p><pre tabindex=0><code>Rubeus.exe asktgt /user:username /certificate:C:\Temp\cert.pfx /password:password123!
</code></pre><p>This allows persistence as this user for as long as the ceritifcate is valid. Looking back at Theft5, this allows persistent access to the user&rsquo;s NTLM hash</p><div class=gdoc-page__anchorwrap><h2 id=persist2---machine-persistence-via-certificates>Persist2 - Machine Persistence via Certificates
<a data-clipboard-text=https://ab0x90.github.io/Active_Directory/Priv_Esc/Active_Directory_Certificate_Services/#persist2---machine-persistence-via-certificates class="gdoc-page__anchor clip flex align-center" title="Anchor to: Persist2 - Machine Persistence via Certificates" aria-label="Anchor to: Persist2 - Machine Persistence via Certificates" href=#persist2---machine-persistence-via-certificates><svg class="gdoc-icon gdoc_link"><use xlink:href="#gdoc_link"/></svg></a></h2></div></article><div class="gdoc-page__footer flex flex-wrap justify-between"></div></div></main><footer class=gdoc-footer><nav class="container flex"><div><section class="flex flex-wrap align-center"><span class="gdoc-footer__item gdoc-footer__item--row">Built with <a href=https://gohugo.io/ class=gdoc-footer__link>Hugo</a> and<svg class="gdoc-icon gdoc_heart"><use xlink:href="#gdoc_heart"/></svg></span></section></div><div class="flex flex-25 justify-end"><span class="gdoc-footer__item text-right"><a class="gdoc-footer__link fake-link" href=# aria-label="Back to top"><svg class="gdoc-icon gdoc_keyboard_arrow_up"><use xlink:href="#gdoc_keyboard_arrow_up"/></svg><span class=hidden-mobile>Back to top</span></a></span></div></nav></footer></div></body></html>